# è‡ªå®šä¹‰èœå•
[è‡ªå®šä¹‰èœå•](https://developers.weixin.qq.com/doc/offiaccount/Custom_Menus/Creating_Custom-Defined_Menu.html)   

#### 1. æ³¨æ„ï¼š
  - è‡ªå®šä¹‰èœå•**æœ€å¤šåŒ…æ‹¬3ä¸ªä¸€çº§èœå•**ï¼Œæ¯ä¸ªä¸€çº§èœå•**æœ€å¤šåŒ…å«5ä¸ªäºŒçº§èœå•**ã€‚
  - ä¸€çº§èœå•æœ€å¤š**4ä¸ªæ±‰å­—**ï¼ŒäºŒçº§èœå•æœ€å¤š**7ä¸ªæ±‰å­—**ï¼Œå¤šå‡ºæ¥çš„éƒ¨åˆ†å°†ä¼šä»¥â€œ...â€ä»£æ›¿ã€‚
  - åˆ›å»ºè‡ªå®šä¹‰èœå•åï¼Œèœå•çš„åˆ·æ–°ç­–ç•¥æ˜¯ï¼Œåœ¨ç”¨æˆ·è¿›å…¥å…¬ä¼—å·ä¼šè¯é¡µæˆ–å…¬ä¼—å·profileé¡µæ—¶ï¼Œå¦‚æœå‘ç°ä¸Šä¸€æ¬¡æ‹‰å–èœå•çš„è¯·æ±‚åœ¨5åˆ†é’Ÿä»¥å‰ï¼Œå°±ä¼šæ‹‰å–ä¸€ä¸‹èœå•ï¼Œå¦‚æœèœå•æœ‰æ›´æ–°ï¼Œå°±ä¼šåˆ·æ–°å®¢æˆ·ç«¯çš„èœå•ã€‚æµ‹è¯•æ—¶å¯ä»¥å°è¯•å–æ¶ˆå…³æ³¨å…¬ä¼—è´¦å·åå†æ¬¡å…³æ³¨ï¼Œåˆ™å¯ä»¥çœ‹åˆ°åˆ›å»ºåçš„æ•ˆæœã€‚â€‹

#### 2. æŒ‰é’®ç±»å‹
  1. clickï¼šç‚¹å‡»æ¨äº‹ä»¶ç”¨æˆ·ç‚¹å‡»clickç±»å‹æŒ‰é’®åï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šé€šè¿‡æ¶ˆæ¯æ¥å£æ¨é€æ¶ˆæ¯ç±»å‹ä¸ºeventçš„ç»“æ„ç»™å¼€å‘è€…ï¼ˆå‚è€ƒæ¶ˆæ¯æ¥å£æŒ‡å—ï¼‰ï¼Œå¹¶ä¸”å¸¦ä¸ŠæŒ‰é’®ä¸­å¼€å‘è€…å¡«å†™çš„keyå€¼ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„keyå€¼ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼›
  2. viewï¼šè·³è½¬URLç”¨æˆ·ç‚¹å‡»viewç±»å‹æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†ä¼šæ‰“å¼€å¼€å‘è€…åœ¨æŒ‰é’®ä¸­å¡«å†™çš„ç½‘é¡µURLï¼Œå¯ä¸ç½‘é¡µæˆæƒè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æ¥å£ç»“åˆï¼Œè·å¾—ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€‚
  3. scancode_pushï¼šæ‰«ç æ¨äº‹ä»¶ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†è°ƒèµ·æ‰«ä¸€æ‰«å·¥å…·ï¼Œå®Œæˆæ‰«ç æ“ä½œåæ˜¾ç¤ºæ‰«æç»“æœï¼ˆå¦‚æœæ˜¯URLï¼Œå°†è¿›å…¥URLï¼‰ï¼Œä¸”ä¼šå°†æ‰«ç çš„ç»“æœä¼ ç»™å¼€å‘è€…ï¼Œå¼€å‘è€…å¯ä»¥ä¸‹å‘æ¶ˆæ¯ã€‚
  4. scancode_waitmsgï¼šæ‰«ç æ¨äº‹ä»¶ä¸”å¼¹å‡ºâ€œæ¶ˆæ¯æ¥æ”¶ä¸­â€æç¤ºæ¡†ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†è°ƒèµ·æ‰«ä¸€æ‰«å·¥å…·ï¼Œå®Œæˆæ‰«ç æ“ä½œåï¼Œå°†æ‰«ç çš„ç»“æœä¼ ç»™å¼€å‘è€…ï¼ŒåŒæ—¶æ”¶èµ·æ‰«ä¸€æ‰«å·¥å…·ï¼Œç„¶åå¼¹å‡ºâ€œæ¶ˆæ¯æ¥æ”¶ä¸­â€æç¤ºæ¡†ï¼Œéšåå¯èƒ½ä¼šæ”¶åˆ°å¼€å‘è€…ä¸‹å‘çš„æ¶ˆæ¯ã€‚
  5. pic_sysphotoï¼šå¼¹å‡ºç³»ç»Ÿæ‹ç…§å‘å›¾ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†è°ƒèµ·ç³»ç»Ÿç›¸æœºï¼Œå®Œæˆæ‹ç…§æ“ä½œåï¼Œä¼šå°†æ‹æ‘„çš„ç›¸ç‰‡å‘é€ç»™å¼€å‘è€…ï¼Œå¹¶æ¨é€äº‹ä»¶ç»™å¼€å‘è€…ï¼ŒåŒæ—¶æ”¶èµ·ç³»ç»Ÿç›¸æœºï¼Œéšåå¯èƒ½ä¼šæ”¶åˆ°å¼€å‘è€…ä¸‹å‘çš„æ¶ˆæ¯ã€‚
  6. pic_photo_or_albumï¼šå¼¹å‡ºæ‹ç…§æˆ–è€…ç›¸å†Œå‘å›¾ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†å¼¹å‡ºé€‰æ‹©å™¨ä¾›ç”¨æˆ·é€‰æ‹©â€œæ‹ç…§â€æˆ–è€…â€œä»æ‰‹æœºç›¸å†Œé€‰æ‹©â€ã€‚ç”¨æˆ·é€‰æ‹©åå³èµ°å…¶ä»–ä¸¤ç§æµç¨‹ã€‚
  7. pic_weixinï¼šå¼¹å‡ºå¾®ä¿¡ç›¸å†Œå‘å›¾å™¨ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†è°ƒèµ·å¾®ä¿¡ç›¸å†Œï¼Œå®Œæˆé€‰æ‹©æ“ä½œåï¼Œå°†é€‰æ‹©çš„ç›¸ç‰‡å‘é€ç»™å¼€å‘è€…çš„æœåŠ¡å™¨ï¼Œå¹¶æ¨é€äº‹ä»¶ç»™å¼€å‘è€…ï¼ŒåŒæ—¶æ”¶èµ·ç›¸å†Œï¼Œéšåå¯èƒ½ä¼šæ”¶åˆ°å¼€å‘è€…ä¸‹å‘çš„æ¶ˆæ¯ã€‚
  8. location_selectï¼šå¼¹å‡ºåœ°ç†ä½ç½®é€‰æ‹©å™¨ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†è°ƒèµ·åœ°ç†ä½ç½®é€‰æ‹©å·¥å…·ï¼Œå®Œæˆé€‰æ‹©æ“ä½œåï¼Œå°†é€‰æ‹©çš„åœ°ç†ä½ç½®å‘é€ç»™å¼€å‘è€…çš„æœåŠ¡å™¨ï¼ŒåŒæ—¶æ”¶èµ·ä½ç½®é€‰æ‹©å·¥å…·ï¼Œéšåå¯èƒ½ä¼šæ”¶åˆ°å¼€å‘è€…ä¸‹å‘çš„æ¶ˆæ¯ã€‚
  9. media_idï¼šä¸‹å‘æ¶ˆæ¯ï¼ˆé™¤æ–‡æœ¬æ¶ˆæ¯ï¼‰ç”¨æˆ·ç‚¹å‡»media_idç±»å‹æŒ‰é’®åï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå°†å¼€å‘è€…å¡«å†™çš„æ°¸ä¹…ç´ æidå¯¹åº”çš„ç´ æä¸‹å‘ç»™ç”¨æˆ·ï¼Œæ°¸ä¹…ç´ æç±»å‹å¯ä»¥æ˜¯å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€å›¾æ–‡æ¶ˆæ¯ã€‚è¯·æ³¨æ„ï¼šæ°¸ä¹…ç´ æidå¿…é¡»æ˜¯åœ¨â€œç´ æç®¡ç†/æ–°å¢æ°¸ä¹…ç´ æâ€æ¥å£ä¸Šä¼ åè·å¾—çš„åˆæ³•idã€‚
  10. view_limitedï¼šè·³è½¬å›¾æ–‡æ¶ˆæ¯URLç”¨æˆ·ç‚¹å‡»view_limitedç±»å‹æŒ‰é’®åï¼Œå¾®ä¿¡å®¢æˆ·ç«¯å°†æ‰“å¼€å¼€å‘è€…åœ¨æŒ‰é’®ä¸­å¡«å†™çš„æ°¸ä¹…ç´ æidå¯¹åº”çš„å›¾æ–‡æ¶ˆæ¯URLï¼Œæ°¸ä¹…ç´ æç±»å‹åªæ”¯æŒå›¾æ–‡æ¶ˆæ¯ã€‚è¯·æ³¨æ„ï¼šæ°¸ä¹…ç´ æidå¿…é¡»æ˜¯åœ¨â€œç´ æç®¡ç†/æ–°å¢æ°¸ä¹…ç´ æâ€æ¥å£ä¸Šä¼ åè·å¾—çš„åˆæ³•idã€‚â€‹


#### 3. å®ä¾‹ä»£ç 
- ç›®å½•ç»“æ„
```js
â”œâ”€ config/           // é…ç½®ç›®å½•
â”‚   â”œâ”€ index.js 		 // å­˜å‚¨é…ç½®ä¿¡æ¯
â”œâ”€  reply/
â”‚   â”œâ”€ index.js		   // æ¥æ”¶å¤„ç†æ‰€æœ‰æ¶ˆæ¯
â”‚   â”œâ”€ reply.js		   // å¤„ç†è¿”å›æ¶ˆæ¯åŠŸèƒ½
â”‚   â”œâ”€ template.js	 // å›å¤æ¶ˆæ¯æ¨¡æ¿æ–‡ä»¶
â”œâ”€  routers/
â”‚   â”œâ”€ index.js		   // è·¯ç”±
â”œâ”€ utils/            // å·¥å…·æ–¹æ³•åº“
â”‚   â”œâ”€ index.js		   // å·¥å…·æ–¹æ³•
â”‚   â”œâ”€ api.js        // ç»Ÿä¸€ç®¡ç†å¾®ä¿¡æ¥å£
â”œâ”€â”€ wechat/          // æ ¸å¿ƒåŠŸèƒ½åº“
â”‚   â”œâ”€ menu.js		   // è‡ªå®šä¹‰èœå•
â”‚   â”œâ”€ wechat.js		 // ç±»wechat
â”œâ”€â”€ app.js           // å…¥å£å¯åŠ¨æ–‡ä»¶
â”œâ”€â”€ package.json     // é…ç½®æ–‡ä»¶

```

2. menu.js
```js
// è‡ªå®šä¹‰èœå•
module.exports = {
  "button":[
    {
      "type":"view",
      "name":"ç¡…è°·ç”µå½±ğŸ¬",
      "url":`https://www.baidu.com/`
    },
    {
      "type":"view",
      "name":"è¯­éŸ³è¯†åˆ«ğŸ¤",
      "url":`https://www.baidu.com/`
    },
    {
      "name": "æˆ³æˆ‘ğŸ’‹",
      "sub_button": [
        {
          "type": "view",
          "name": "å®˜ç½‘â˜€",
          "url": "http://www.atguigu.com"
        },
        {
          "type": "click",
          "name": "å¸®åŠ©ğŸ™",
          "key": "help"
        }
      ]
    }
  ]
}
```

3. wechat.js
- **createMenu()** åˆ›å»ºèœå•
- **deleteMenu()** åˆ é™¤èœå•
```js
const {writeFileAsync, readFileAsync} = require('../utils')
//å¼•å…¥ config æ¨¡å—
const config = require('../config')
//å¼•å…¥ axios æ¨¡å—
const axios = require('axios');
//å¼•å…¥ api æ¨¡å—
const Api = require('./../utils/api');
//å¼•å…¥ menu æ¨¡å—
const menus = require('./menu');

class Wechat {
  constructor(opts){
  }
  // --------------------- access_token ------------------------------
  // è·å–access_token 
  getAccessToken () {
    const {appId, appsecret} = config; // å‚æ•°
    const url = `${Api.accessToken}&appid=${appId}&secret=${appsecret}`; // è¯·æ±‚åœ°å€
    // ç”¨ promise å°†å›è°ƒå‡½æ•°ä¸­çš„æ•°æ®è¿”å›å‡ºå»
    return new Promise((resolve, reject)=>{
      axios.get(url).then(res => {
        console.log('getAccessTokenæˆåŠŸ', res.data)
        //è®¾ç½®access_tokençš„è¿‡æœŸæ—¶é—´ ï¼š å½“å‰æ—¶é—´ + (7200 - 5åˆ†é’Ÿ) * 1000
        res.data.expires_in = Date.now() + (res.data.expires_in - 300) * 1000;
        resolve(res.data)
      }).catch(err => {
        // è¯·æ±‚å¤±è´¥
        reject('getAccessToken é”™è¯¯ï¼š' + err);
      })
    })
  }

  // åˆ›å»ºå†™å…¥ access_token.txt
  saveAccessToken (accessToken) {
    return writeFileAsync(accessToken,'access_token.txt')
  }

  // è¯»å–å‡­æ® access_token
  readAccessToken () {
    return readFileAsync('access_token.txt')
  }

  // åˆ¤æ–­å‡­æ®æ˜¯å¦è¿‡æœŸ ï¼ˆæœªè¿‡æœŸ true; è¿‡æœŸ falseï¼‰
  isValidAccessToken(data) {
    if(!data || !data.access_token || !data.expires_in) return false;
    // åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
    return data.expires_in > Date.now();
  }

  // ç”¨æ¥è·å–æ²¡æœ‰è¿‡æœŸçš„access_token
  fetchAccessToken () {
    console.log('this',this);
    if(this.access_token && this.expires_in && this.isValidAccessToken(this)) {
      return Promise.resolve({
        access_token: this.access_token, 
        expires_in: this.expires_in
      });
    }
    return this.readAccessToken()
      .then(async res => {
        if(this.isValidAccessToken(res)){
          // æ²¡æœ‰è¿‡æœŸç›´æ¥ä½¿ç”¨
          return Promise.resolve(res)
        }else {
          // é‡æ–°å‘é€è¯·æ±‚è·å–å‡­æ®
          const data = await this.getAccessToken();
          // ä¿å­˜
          await this.saveAccessToken(data);
          // å°†è¯·æ±‚å›æ¥çš„å‡­æ®è¿”å›å‡ºå»
          return Promise.resolve(data)
        }
      })
      .catch(async err => {
        console.log('fetchAccessToken: '+err);
        // é‡æ–°å‘é€è¯·æ±‚è·å–å‡­æ®
        const data = await this.getAccessToken();
        // ä¿å­˜
        await this.saveAccessToken(data);
        // å°†å‡­æ®è¿”å›å‡ºå»
        return Promise.resolve(data);
      })
      .then(res => {
        //å°†å…¶è¯·æ±‚å›æ¥çš„å‡­æ®å’Œè¿‡æœŸæ—¶é—´æŒ‚è½½åˆ°thisä¸Š
        this.access_token = res.access_token;
        this.expires_in = res.expires_in;
        //æŒ‡å®šfetchAccessTokenæ–¹æ³•è¿”å›å€¼
        return Promise.resolve(res);
      })
  }

  /**
   * ç”¨æ¥åˆ›å»ºè‡ªå®šä¹‰èœå•
   * @param menu èœå•é…ç½®å¯¹è±¡
   * @return {Promise<any>}
   */
  createMenu(menu) {
    return new Promise(async (resolve,reject) => {
      //  è·å–access_token
      const token = await this.fetchAccessToken();
      // è¯·æ±‚åœ°å€
      const url = `${Api.menu.create}access_token=${token.access_token}`;
      //å‘é€è¯·æ±‚
      const headers = {'Content-Type': 'application/x-www-form-urlencoded'}
      axios.post(url, menu, headers).then(res => {
        let data = res.data;
        if(data.errcode === 0) {
          resolve()
          console.log('createMenu Res',data)
        } else {
          throw new Error(JSON.stringify(data));
        }
      })
      .catch(err => {
        reject('createMenu Err:' + err);
      })
      
    })
  }
  /**
   * ç”¨æ¥åˆ é™¤è‡ªå®šä¹‰èœå•çš„
   * @return {Promise<any>}
   */
  deleteMenu() {
    return new Promise(async (resolve, reject) => {
      const token = await this.fetchAccessToken();
      // å®šä¹‰è¯·æ±‚åœ°å€
      const url = `${Api.menu.delete}access_token=${token.access_token}`;
      // å‘é€è¯·æ±‚
      axios.get(url).then(res => {
        let data = res.data;
        if(data.errcode === 0){
          resolve()
          console.log('deleteMenu res',data)
        } else {
          throw new Error(JSON.stringify(data));
        }
      }).catch(err => {
        console.log('deleteMenu Err'+ err)
        reject('createMenu Err:' + err);
      });
    })
  }
}
(async () => {
 //åˆ›å»ºå®ä¾‹å¯¹è±¡
 const w = new Wechat();
//  await w.fetchAccessToken();
 await w.deleteMenu();
 await w.createMenu(menus);

})()
    
module.exports = Wechat;

```
4. api.js
- menu èœå•æ¥å£é…ç½®
```js
// åœ°å€å‰ç¼€

const prefix = 'https://api.weixin.qq.com/cgi-bin/';

module.exports = {
  accessToken: `${prefix}token?grant_type=client_credential`,
  ticket: `${prefix}ticket/getticket?type=jsapi`,
  menu: {
    create: `${prefix}menu/create?`,
    delete: `${prefix}menu/delete?`
  },
  temporary: {
    upload: `${prefix}media/upload?`,
    get: `${prefix}media/get?`
  },
  permanment: {
    uploadNews: `${prefix}material/add_news?`,
    uploadImg: `${prefix}media/uploadimg?`,
    uploadOthers: `${prefix}material/add_material?`,
    get: `${prefix}material/get_material?`
  }
}
```